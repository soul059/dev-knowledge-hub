# Chapter 6.2: TCP Protocol

[â† Back to Table of Contents](../README.md)

---

## ğŸ“š Chapter Overview

TCP (Transmission Control Protocol) is the primary transport protocol for reliable data delivery on the Internet. This chapter covers TCP segment structure, connection management, and reliability mechanisms.

---

## ğŸ¯ Learning Objectives

- Understand TCP segment header structure
- Master the 3-way handshake and 4-way termination
- Learn about sequence numbers and acknowledgments
- Explore TCP state machine basics

---

## 1. TCP Segment Structure

### TCP Header Format

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TCP SEGMENT HEADER                               â”‚
â”‚                                                                     â”‚
â”‚    Minimum header size: 20 bytes (without options)                 â”‚
â”‚    Maximum header size: 60 bytes (with options)                    â”‚
â”‚                                                                     â”‚
â”‚   0                   1                   2                   3    â”‚
â”‚   0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚       Source Port (16)      â”‚     Destination Port (16)       â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚                    Sequence Number (32)                        â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚                 Acknowledgment Number (32)                     â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚Data   â”‚ Res   â”‚Uâ”‚Aâ”‚Pâ”‚Râ”‚Sâ”‚Fâ”‚                                   â”‚ â”‚
â”‚  â”‚Offset â”‚ (4)   â”‚Râ”‚Câ”‚Sâ”‚Sâ”‚Yâ”‚Iâ”‚        Window Size (16)           â”‚ â”‚
â”‚  â”‚(4)    â”‚       â”‚Gâ”‚Kâ”‚Hâ”‚Tâ”‚Nâ”‚Nâ”‚                                   â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”´â”€â”´â”€â”´â”€â”´â”€â”´â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚        Checksum (16)        â”‚      Urgent Pointer (16)        â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚                    Options (0-40 bytes)                        â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚                         DATA                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Header Field Descriptions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TCP HEADER FIELDS                                â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Field                â”‚ Description                          â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ Source Port (16b)    â”‚ Sender's port number                 â”‚   â”‚
â”‚  â”‚ Dest Port (16b)      â”‚ Receiver's port number               â”‚   â”‚
â”‚  â”‚ Sequence # (32b)     â”‚ Byte position of first data byte     â”‚   â”‚
â”‚  â”‚ Ack Number (32b)     â”‚ Next expected byte from other side   â”‚   â”‚
â”‚  â”‚ Data Offset (4b)     â”‚ Header length in 32-bit words        â”‚   â”‚
â”‚  â”‚ Reserved (4b)        â”‚ Reserved for future use              â”‚   â”‚
â”‚  â”‚ Flags (6b)           â”‚ Control bits (URG,ACK,PSH,RST,SYN,FIN)â”‚   â”‚
â”‚  â”‚ Window (16b)         â”‚ Receive buffer space available       â”‚   â”‚
â”‚  â”‚ Checksum (16b)       â”‚ Error detection                      â”‚   â”‚
â”‚  â”‚ Urgent Pointer (16b) â”‚ Offset to urgent data (if URG set)   â”‚   â”‚
â”‚  â”‚ Options (variable)   â”‚ MSS, timestamps, window scaling      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚    TCP FLAGS (Control Bits):                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  URG (Urgent)     - Urgent data present                     â”‚ â”‚
â”‚    â”‚  ACK (Acknowledge) - Acknowledgment number valid            â”‚ â”‚
â”‚    â”‚  PSH (Push)       - Push data to application immediately    â”‚ â”‚
â”‚    â”‚  RST (Reset)      - Reset the connection                    â”‚ â”‚
â”‚    â”‚  SYN (Synchronize) - Initiate connection                    â”‚ â”‚
â”‚    â”‚  FIN (Finish)     - No more data, close connection          â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Sequence and Acknowledgment Numbers

### How They Work

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SEQUENCE NUMBERS                                 â”‚
â”‚                                                                     â”‚
â”‚    Sequence numbers count BYTES, not segments                      â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  If sending 3000 bytes of data starting at seq=1000:        â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  Segment 1: Seq=1000, Data bytes 1000-1499 (500 bytes)      â”‚ â”‚
â”‚    â”‚  Segment 2: Seq=1500, Data bytes 1500-1999 (500 bytes)      â”‚ â”‚
â”‚    â”‚  Segment 3: Seq=2000, Data bytes 2000-2499 (500 bytes)      â”‚ â”‚
â”‚    â”‚  Segment 4: Seq=2500, Data bytes 2500-2999 (500 bytes)      â”‚ â”‚
â”‚    â”‚  Segment 5: Seq=3000, Data bytes 3000-3499 (500 bytes)      â”‚ â”‚
â”‚    â”‚  Segment 6: Seq=3500, Data bytes 3500-3999 (500 bytes)      â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  Next sequence number = 1000 + 3000 = 4000                  â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚    ACKNOWLEDGMENT NUMBERS:                                          â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  ACK = Next byte expected from sender                       â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  If receiver gets Seq=1000 with 500 bytes:                  â”‚ â”‚
â”‚    â”‚  Receiver sends ACK=1500 ("I got up to 1499, send 1500")    â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  If receiver gets Seq=1500 with 500 bytes:                  â”‚ â”‚
â”‚    â”‚  Receiver sends ACK=2000 ("I got up to 1999, send 2000")    â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  This is CUMULATIVE acknowledgment                          â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Transfer Example

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SEQUENCE NUMBER EXAMPLE                          â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚                                                          â”‚    â”‚
â”‚    â”‚   CLIENT                              SERVER             â”‚    â”‚
â”‚    â”‚   (ISN=1000)                         (ISN=5000)          â”‚    â”‚
â”‚    â”‚      â”‚                                    â”‚              â”‚    â”‚
â”‚    â”‚      â”‚ â”€â”€â”€ Seq=1000, ACK=5001, 100b â”€â”€â”€â”€â†’ â”‚              â”‚    â”‚
â”‚    â”‚      â”‚     "Here's bytes 1000-1099"       â”‚              â”‚    â”‚
â”‚    â”‚      â”‚                                    â”‚              â”‚    â”‚
â”‚    â”‚      â”‚ â†â”€â”€ Seq=5001, ACK=1100 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚              â”‚    â”‚
â”‚    â”‚      â”‚     "Got it, send 1100 next"       â”‚              â”‚    â”‚
â”‚    â”‚      â”‚                                    â”‚              â”‚    â”‚
â”‚    â”‚      â”‚ â”€â”€â”€ Seq=1100, ACK=5001, 200b â”€â”€â”€â”€â†’ â”‚              â”‚    â”‚
â”‚    â”‚      â”‚     "Here's bytes 1100-1299"       â”‚              â”‚    â”‚
â”‚    â”‚      â”‚                                    â”‚              â”‚    â”‚
â”‚    â”‚      â”‚ â†â”€â”€ Seq=5001, ACK=1300, 150b â”€â”€â”€â”€â”€ â”‚              â”‚    â”‚
â”‚    â”‚      â”‚     "Got it, here's my 150 bytes"  â”‚              â”‚    â”‚
â”‚    â”‚      â”‚     (Piggybacking)                 â”‚              â”‚    â”‚
â”‚    â”‚      â”‚                                    â”‚              â”‚    â”‚
â”‚    â”‚      â”‚ â”€â”€â”€ Seq=1300, ACK=5151 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚              â”‚    â”‚
â”‚    â”‚      â”‚     "Got your data, next=5151"     â”‚              â”‚    â”‚
â”‚    â”‚      â”‚                                    â”‚              â”‚    â”‚
â”‚    â”‚                                                          â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                     â”‚
â”‚    KEY POINTS:                                                      â”‚
â”‚    â€¢ Seq = Starting byte of data being sent                        â”‚
â”‚    â€¢ ACK = Next byte expected from other side                      â”‚
â”‚    â€¢ ACK flag must be set for ACK number to be valid               â”‚
â”‚    â€¢ Data can be piggybacked with ACKs (bidirectional)             â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. TCP Connection Establishment (3-Way Handshake)

### The Process

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TCP 3-WAY HANDSHAKE                              â”‚
â”‚                                                                     â”‚
â”‚    Purpose: Establish connection and synchronize sequence numbers  â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚   CLIENT                              SERVER                 â”‚ â”‚
â”‚    â”‚   (Active Open)                       (Passive Open)         â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚  CLOSED                              LISTEN                  â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚ â”€â”€â”€â”€â”€â”€ SYN, Seq=x â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  STEP 1          â”‚ â”‚
â”‚    â”‚      â”‚        (SYN flag set)              â”‚                  â”‚ â”‚
â”‚    â”‚  SYN_SENT                                 â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚                                SYN_RCVD               â”‚ â”‚
â”‚    â”‚      â”‚ â†â”€â”€â”€â”€â”€ SYN+ACK, Seq=y, Ack=x+1 â”€â”€â”€ â”‚  STEP 2          â”‚ â”‚
â”‚    â”‚      â”‚        (SYN and ACK flags set)     â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚ â”€â”€â”€â”€â”€â”€ ACK, Seq=x+1, Ack=y+1 â”€â”€â”€â”€â†’ â”‚  STEP 3          â”‚ â”‚
â”‚    â”‚      â”‚        (ACK flag set)              â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚  ESTABLISHED                         ESTABLISHED             â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚ â†â”€â”€â”€â”€â”€ Data Transfer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚    STEP-BY-STEP:                                                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚  Step 1 (SYN):                                              â”‚ â”‚
â”‚    â”‚    Client sends SYN segment                                 â”‚ â”‚
â”‚    â”‚    Contains client's Initial Sequence Number (ISN)          â”‚ â”‚
â”‚    â”‚    "I want to connect, my starting number is x"             â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  Step 2 (SYN-ACK):                                          â”‚ â”‚
â”‚    â”‚    Server responds with SYN+ACK                             â”‚ â”‚
â”‚    â”‚    Contains server's ISN and ACKs client's SYN              â”‚ â”‚
â”‚    â”‚    "OK, my starting number is y, I got your x"              â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  Step 3 (ACK):                                              â”‚ â”‚
â”‚    â”‚    Client sends ACK to confirm server's SYN                 â”‚ â”‚
â”‚    â”‚    Connection is now established                            â”‚ â”‚
â”‚    â”‚    "Got it, let's communicate"                              â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Why 3 Packets?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WHY 3-WAY HANDSHAKE?                             â”‚
â”‚                                                                     â”‚
â”‚    PURPOSE:                                                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  1. BOTH sides agree to communicate                         â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  2. BOTH sides know the other is ready                      â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  3. BOTH sides synchronize their sequence numbers           â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  4. BOTH sides confirm they can send AND receive            â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚    WHY NOT 2-WAY?                                                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  With only 2 messages:                                      â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  Client â†’ SYN â†’ Server                                      â”‚ â”‚
â”‚    â”‚  Client â† SYN+ACK â† Server                                  â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  Problem: Server doesn't know if client got SYN+ACK!       â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  OLD DUPLICATE PROBLEM:                                     â”‚ â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚    â”‚  â”‚ Old SYN arrives at server (delayed from past)        â”‚  â”‚ â”‚
â”‚    â”‚  â”‚ Server thinks it's new connection, sends SYN+ACK     â”‚  â”‚ â”‚
â”‚    â”‚  â”‚ Server allocates resources for "ghost" connection    â”‚  â”‚ â”‚
â”‚    â”‚  â”‚ Client never responds (it was old packet!)           â”‚  â”‚ â”‚
â”‚    â”‚  â”‚ â†’ Resource waste and security issues                 â”‚  â”‚ â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  3rd packet (ACK) confirms client is really there          â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. TCP Connection Termination (4-Way Handshake)

### Graceful Termination

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TCP 4-WAY TERMINATION                            â”‚
â”‚                                                                     â”‚
â”‚    Either side can initiate termination                            â”‚
â”‚    Each direction closed independently (half-close possible)       â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚   CLIENT                              SERVER                 â”‚ â”‚
â”‚    â”‚   (initiates close)                                          â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚  ESTABLISHED                         ESTABLISHED             â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚ â”€â”€â”€â”€â”€â”€ FIN, Seq=u â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  STEP 1          â”‚ â”‚
â”‚    â”‚      â”‚        "I'm done sending"          â”‚                  â”‚ â”‚
â”‚    â”‚  FIN_WAIT_1                               â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚                                CLOSE_WAIT             â”‚ â”‚
â”‚    â”‚      â”‚ â†â”€â”€â”€â”€â”€ ACK, Ack=u+1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  STEP 2          â”‚ â”‚
â”‚    â”‚      â”‚        "OK, got your FIN"          â”‚                  â”‚ â”‚
â”‚    â”‚  FIN_WAIT_2                               â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚   (Server can still send data)     â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚ â†â”€â”€â”€â”€â”€ FIN, Seq=v â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  STEP 3          â”‚ â”‚
â”‚    â”‚      â”‚        "I'm done too"              â”‚                  â”‚ â”‚
â”‚    â”‚  TIME_WAIT                            LAST_ACK               â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚ â”€â”€â”€â”€â”€â”€ ACK, Ack=v+1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  STEP 4          â”‚ â”‚
â”‚    â”‚      â”‚        "Got it, goodbye"           â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚                                 CLOSED                â”‚ â”‚
â”‚    â”‚  (Wait 2Ã—MSL)                             â”‚                  â”‚ â”‚
â”‚    â”‚  CLOSED                                   â”‚                  â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚    MSL = Maximum Segment Lifetime (typically 2 minutes)           â”‚
â”‚    TIME_WAIT = 2Ã—MSL (allows old packets to die)                  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Half-Close

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TCP HALF-CLOSE                                   â”‚
â”‚                                                                     â”‚
â”‚    One side can stop sending while still receiving                 â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚   CLIENT                              SERVER                 â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚ â”€â”€â”€â”€â”€â”€ FIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚        "I'm done sending"          â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚ â†â”€â”€â”€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚ â†â”€â”€â”€â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  Server can        â”‚ â”‚
â”‚    â”‚      â”‚ â†â”€â”€â”€â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  still send!       â”‚ â”‚
â”‚    â”‚      â”‚ â†â”€â”€â”€â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                    â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚ â”€â”€â”€â”€â”€â”€ ACKs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚ â†â”€â”€â”€â”€â”€ FIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚        "Now I'm done too"          â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚ â”€â”€â”€â”€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚                  â”‚ â”‚
â”‚    â”‚      â”‚                                    â”‚                  â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚   USE CASE: Client requests file, server sends data         â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. TCP State Machine

### Connection States

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TCP STATE DIAGRAM (Simplified)                   â”‚
â”‚                                                                     â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                        â”‚  CLOSED  â”‚                                â”‚
â”‚                        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚              â”‚                             â”‚                       â”‚
â”‚              â†“                             â†“                       â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚     â”‚    LISTEN      â”‚            â”‚   SYN_SENT     â”‚              â”‚
â”‚     â”‚ (Server waits) â”‚            â”‚ (Client init)  â”‚              â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚             â”‚                             â”‚                       â”‚
â”‚             â†“                             â”‚                       â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚                       â”‚
â”‚     â”‚   SYN_RCVD     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚             â”‚                                                      â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                          â”‚                                         â”‚
â”‚                          â†“                                         â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                  â”‚  ESTABLISHED  â”‚  â† Normal data transfer        â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚              â”‚                       â”‚                            â”‚
â”‚              â†“                       â†“                            â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚     â”‚  FIN_WAIT_1    â”‚      â”‚  CLOSE_WAIT    â”‚                    â”‚
â”‚     â”‚ (Active close) â”‚      â”‚ (Passive close)â”‚                    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚             â†“                       â†“                             â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚     â”‚  FIN_WAIT_2    â”‚      â”‚   LAST_ACK     â”‚                    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚             â”‚                       â”‚                             â”‚
â”‚             â†“                       â”‚                             â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                             â”‚
â”‚     â”‚  TIME_WAIT     â”‚              â”‚                             â”‚
â”‚     â”‚  (2Ã—MSL wait)  â”‚              â”‚                             â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                             â”‚
â”‚             â”‚                       â”‚                             â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                          â”‚                                         â”‚
â”‚                          â†“                                         â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                  â”‚    CLOSED     â”‚                                 â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key States Explained

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TCP STATES EXPLAINED                             â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ State        â”‚ Description                                  â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ CLOSED       â”‚ No connection exists                         â”‚   â”‚
â”‚  â”‚ LISTEN       â”‚ Server waiting for connection requests       â”‚   â”‚
â”‚  â”‚ SYN_SENT     â”‚ Client sent SYN, waiting for SYN-ACK        â”‚   â”‚
â”‚  â”‚ SYN_RCVD     â”‚ Server received SYN, sent SYN-ACK           â”‚   â”‚
â”‚  â”‚ ESTABLISHED  â”‚ Connection open, data can flow              â”‚   â”‚
â”‚  â”‚ FIN_WAIT_1   â”‚ Sent FIN, waiting for ACK                   â”‚   â”‚
â”‚  â”‚ FIN_WAIT_2   â”‚ FIN ACKed, waiting for other FIN            â”‚   â”‚
â”‚  â”‚ CLOSE_WAIT   â”‚ Received FIN, waiting for app to close      â”‚   â”‚
â”‚  â”‚ LAST_ACK     â”‚ Sent FIN, waiting for final ACK             â”‚   â”‚
â”‚  â”‚ TIME_WAIT    â”‚ Waiting 2Ã—MSL before fully closing          â”‚   â”‚
â”‚  â”‚ CLOSING      â”‚ Both sides sent FIN simultaneously          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚    WHY TIME_WAIT?                                                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚  1. Allow delayed packets to arrive and be discarded       â”‚ â”‚
â”‚    â”‚  2. Ensure final ACK reaches other side                    â”‚ â”‚
â”‚    â”‚  3. Prevent old connection data mixing with new            â”‚ â”‚
â”‚    â”‚  4. Wait = 2 Ã— MSL (typically 4 minutes)                   â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. TCP Options

### Common TCP Options

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TCP OPTIONS                                      â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Option           â”‚ Purpose                                  â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ MSS              â”‚ Maximum Segment Size                     â”‚   â”‚
â”‚  â”‚ (Max Seg Size)   â”‚ Largest amount of data per segment       â”‚   â”‚
â”‚  â”‚                  â”‚ Typical: 1460 bytes (Ethernet MTU-40)    â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ Window Scaling   â”‚ Allows window > 65535 bytes              â”‚   â”‚
â”‚  â”‚                  â”‚ Multiplier for window field              â”‚   â”‚
â”‚  â”‚                  â”‚ Enables high-bandwidth connections       â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ SACK             â”‚ Selective Acknowledgment                 â”‚   â”‚
â”‚  â”‚                  â”‚ Report non-contiguous received blocks    â”‚   â”‚
â”‚  â”‚                  â”‚ Improves retransmission efficiency       â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ Timestamps       â”‚ Round-trip time measurement              â”‚   â”‚
â”‚  â”‚                  â”‚ Protection against wrapped sequences     â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ No-Operation     â”‚ Padding for alignment                    â”‚   â”‚
â”‚  â”‚ (NOP)            â”‚                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚    MSS CALCULATION:                                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  Ethernet MTU = 1500 bytes                                  â”‚ â”‚
â”‚    â”‚  - IP Header  = 20 bytes                                    â”‚ â”‚
â”‚    â”‚  - TCP Header = 20 bytes                                    â”‚ â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                      â”‚ â”‚
â”‚    â”‚  MSS         = 1460 bytes (max TCP data per segment)        â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  Negotiated during 3-way handshake                          â”‚ â”‚
â”‚    â”‚  Each side announces its MSS                                â”‚ â”‚
â”‚    â”‚  Use the SMALLER of the two                                 â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Summary Table

| Component | Description | Size/Range |
|-----------|-------------|------------|
| **Source Port** | Sender's port | 16 bits (0-65535) |
| **Destination Port** | Receiver's port | 16 bits (0-65535) |
| **Sequence Number** | Byte counter | 32 bits |
| **ACK Number** | Next expected byte | 32 bits |
| **Window Size** | Receive buffer space | 16 bits (+ scaling) |
| **SYN** | Connection initiation | Flag bit |
| **ACK** | Acknowledgment valid | Flag bit |
| **FIN** | Connection termination | Flag bit |
| **RST** | Reset connection | Flag bit |

---

## â“ Quick Revision Questions

1. **Q:** What are the three steps of the TCP 3-way handshake?
   <details>
   <summary>Answer</summary>
   1. **SYN** (Client â†’ Server): Client sends SYN with its Initial Sequence Number (ISN)
   2. **SYN-ACK** (Server â†’ Client): Server responds with SYN (its ISN) + ACK (client's ISN + 1)
   3. **ACK** (Client â†’ Server): Client sends ACK (server's ISN + 1)
   
   After this, connection is ESTABLISHED on both sides.
   </details>

2. **Q:** Why does TCP termination need 4 packets instead of 3?
   <details>
   <summary>Answer</summary>
   TCP termination is **half-duplex** - each direction closes independently:
   
   1. **FIN** (A â†’ B): "I'm done sending"
   2. **ACK** (B â†’ A): "OK, got your FIN"
   3. **FIN** (B â†’ A): "I'm done sending too"
   4. **ACK** (A â†’ B): "OK, got your FIN"
   
   B might still have data to send after receiving A's FIN (half-close), so it can't combine its FIN with the ACK immediately.
   </details>

3. **Q:** What is the purpose of sequence numbers in TCP?
   <details>
   <summary>Answer</summary>
   **Sequence numbers** serve multiple purposes:
   
   1. **Ordering**: Receiver can reassemble data in correct order
   2. **Duplicate detection**: Identify and discard duplicate segments
   3. **Acknowledgment**: ACK number indicates next expected byte
   4. **Loss detection**: Missing sequence indicates lost segment
   5. **Flow control**: Track how much data is in transit
   
   Each byte of data has a unique sequence number.
   </details>

4. **Q:** What is the TIME_WAIT state and why does it exist?
   <details>
   <summary>Answer</summary>
   **TIME_WAIT** occurs after sending final ACK in connection termination.
   
   Duration: 2 Ã— MSL (Maximum Segment Lifetime â‰ˆ 2-4 minutes)
   
   **Why it exists**:
   1. Ensure final ACK is received (can retransmit if lost)
   2. Allow old delayed packets to expire
   3. Prevent new connections from receiving old data
   4. Avoid "incarnation" problems with same socket pair
   </details>

5. **Q:** What are the main TCP flags and their purposes?
   <details>
   <summary>Answer</summary>
   **6 main TCP flags**:
   
   | Flag | Name | Purpose |
   |------|------|---------|
   | SYN | Synchronize | Start connection, exchange ISN |
   | ACK | Acknowledge | ACK number field is valid |
   | FIN | Finish | Sender is done, close connection |
   | RST | Reset | Abort connection immediately |
   | PSH | Push | Deliver data immediately to app |
   | URG | Urgent | Urgent pointer field is valid |
   </details>

6. **Q:** What is MSS and how is it determined?
   <details>
   <summary>Answer</summary>
   **MSS** = Maximum Segment Size
   
   The largest amount of data (not including headers) that can be sent in a single TCP segment.
   
   **Calculation**:
   ```
   MSS = MTU - IP Header - TCP Header
   MSS = 1500 - 20 - 20 = 1460 bytes (typical Ethernet)
   ```
   
   **Negotiation**:
   - Each side announces its MSS during 3-way handshake
   - Communicated via TCP Options
   - Connection uses the smaller of the two values
   </details>

---

## ğŸ”— Navigation

| Previous | Up | Next |
|----------|-----|------|
| [â† Transport Layer Basics](01-transport-layer-basics.md) | [Table of Contents](../README.md) | [UDP Protocol â†’](03-udp-protocol.md) |

---

*Â© 2025 Computer Networking Study Notes. For educational purposes.*
