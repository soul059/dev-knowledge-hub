# Chapter 6.1: Container Image Security Scanning

## Overview

Container images package application code with all dependencies, including the OS layer. Vulnerabilities in any layer compromise the container. This chapter covers image scanning tools, integration patterns, and vulnerability remediation for container images.

---

## Container Image Layers

```
CONTAINER IMAGE STRUCTURE:

  ┌──────────────────────────────────────────────────────────┐
  │  YOUR APPLICATION CODE          ← You control           │
  │  pip install app-dependencies   ← SCA territory          │
  ├──────────────────────────────────────────────────────────┤
  │  System packages (curl, openssl, libxml2)               │
  │  ← OS-level vulnerabilities (IMAGE SCANNING)            │
  ├──────────────────────────────────────────────────────────┤
  │  BASE IMAGE (python:3.11, node:20, ubuntu:22.04)        │
  │  ← Most vulnerabilities live here                       │
  └──────────────────────────────────────────────────────────┘

  VULNERABILITY DISTRIBUTION:
  ┌─────────────────────────────────────────────────────┐
  │ Base OS packages    ████████████████████ 60-80%     │
  │ App dependencies    ████████            15-25%       │
  │ Your code           ██                   5-10%       │
  └─────────────────────────────────────────────────────┘
```

---

## Image Scanning Tools

```
CONTAINER SCANNING TOOL COMPARISON:

  ┌──────────────┬──────────┬──────────┬──────────┬──────────┐
  │ Feature       │ Trivy    │ Grype    │ Snyk     │ Clair    │
  ├──────────────┼──────────┼──────────┼──────────┼──────────┤
  │ Cost          │ Free     │ Free     │ Freemium │ Free     │
  │ Speed         │ Fast     │ Fast     │ Medium   │ Slow     │
  │ OS Vulns      │ Yes      │ Yes      │ Yes      │ Yes      │
  │ App Deps      │ Yes      │ Yes      │ Yes      │ No       │
  │ SBOM          │ Yes      │ Yes      │ Yes      │ No       │
  │ IaC scan      │ Yes      │ No       │ Yes      │ No       │
  │ Secret detect │ Yes      │ No       │ No       │ No       │
  │ CI/CD         │ Excellent│ Good     │ Excellent│ Good     │
  └──────────────┴──────────┴──────────┴──────────┴──────────┘
```

---

## Trivy Image Scanning

```bash
# Scan a public image
trivy image nginx:latest
trivy image python:3.11-slim

# Scan with severity filter
trivy image --severity HIGH,CRITICAL myapp:latest

# Scan and fail on findings (for CI/CD)
trivy image --exit-code 1 --severity CRITICAL myapp:latest

# JSON output for parsing
trivy image --format json --output results.json myapp:latest

# Scan local image (not pushed to registry)
docker build -t myapp:test .
trivy image myapp:test

# Generate SBOM from image
trivy image --format cyclonedx --output sbom.json myapp:latest

# Scan with secret detection
trivy image --scanners vuln,secret,misconfig myapp:latest

# Ignore unfixed vulnerabilities
trivy image --ignore-unfixed myapp:latest
```

### Trivy CI/CD Integration

```yaml
# GitHub Actions
name: Container Security
on:
  push:
    branches: [main]
  pull_request:

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Image
        run: docker build -t myapp:${{ github.sha }} .
      
      - name: Trivy Vulnerability Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'myapp:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
      
      - name: Upload Scan Results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Push if Clean
        if: success()
        run: |
          docker tag myapp:${{ github.sha }} registry.company.com/myapp:latest
          docker push registry.company.com/myapp:latest
```

---

## Grype (Anchore)

```bash
# Install Grype
curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh

# Scan image
grype nginx:latest
grype myapp:latest --only-fixed     # Show only fixable vulns
grype myapp:latest --fail-on high   # Fail on high severity

# Scan from SBOM (generated by Syft)
syft myapp:latest -o json > sbom.json
grype sbom:sbom.json

# Output formats
grype myapp:latest -o json > results.json
grype myapp:latest -o table
grype myapp:latest -o sarif > results.sarif
```

---

## Scanning in the Pipeline

```
IMAGE SCANNING PIPELINE POSITIONS:

  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
  │ Build    │───→│ Scan     │───→│ Push to  │───→│ Deploy   │
  │ Image    │    │ Image    │    │ Registry │    │          │
  └──────────┘    └──────────┘    └──────────┘    └──────────┘
       │               │               │               │
       ▼               ▼               ▼               ▼
  Dockerfile      Trivy/Grype     Registry scan   Runtime scan
  lint (hadolint) before push     (admission ctrl) (Falco)

  SCAN AT EVERY STAGE:
  1. BUILD:    Scan before pushing to registry
  2. REGISTRY: Continuous scanning of stored images
  3. DEPLOY:   Admission controller checks at deploy time
  4. RUNTIME:  Monitor running containers for new CVEs
```

---

## Registry-Level Scanning

```
CONTAINER REGISTRY SCANNING:

  ┌─────────────────────────────────────────────────────────┐
  │ Registry (Harbor / ECR / GCR / ACR)                     │
  │                                                          │
  │  ┌────────────┐  ┌────────────┐  ┌────────────┐        │
  │  │ myapp:v1   │  │ myapp:v2   │  │ myapp:v3   │        │
  │  │ Scanned: ✓ │  │ Scanned: ✓ │  │ Scanned: ✓ │        │
  │  │ Vulns: 0   │  │ Vulns: 3   │  │ Vulns: 0   │        │
  │  │ Status: OK │  │ Status: ⚠  │  │ Status: OK │        │
  │  └────────────┘  └────────────┘  └────────────┘        │
  │                                                          │
  │  Policy: Block pull of images with CRITICAL vulns       │
  │  Re-scan: Every 24 hours (new CVEs published daily)     │
  └─────────────────────────────────────────────────────────┘
```

```bash
# AWS ECR Enhanced Scanning
aws ecr put-image-scanning-configuration \
    --repository-name myapp \
    --image-scanning-configuration scanOnPush=true

# Harbor - enable Trivy scanning
# harbor.yml
trivy:
  enabled: true
  insecure: false
  github_token: ${GITHUB_TOKEN}
```

---

## Troubleshooting Tips

| Problem | Cause | Solution |
|---------|-------|----------|
| Hundreds of vulns in base image | Using full OS image (ubuntu, debian) | Switch to slim/distroless/alpine base image |
| Vulnerability has no fix | OS package maintainer hasn't patched | Use `--ignore-unfixed`; mitigate at runtime; switch base image |
| Scan takes too long | Large image with many layers | Use smaller base images; cache Trivy DB in CI |
| Same CVE reported by multiple scanners | Different scanners, same vuln | Deduplicate by CVE ID; use one primary scanner |
| Image passes scan but fails in production | New CVE published after scan | Enable continuous registry scanning; re-scan before deployment |

---

## Summary Table

| Concept | Description |
|---------|-------------|
| **Image Scanning** | Detecting vulnerabilities in container image layers |
| **Base Image** | Foundation layer containing OS and system packages |
| **OS-level Vulns** | Vulnerabilities in system packages (openssl, curl, etc.) |
| **Registry Scanning** | Continuous scanning of images stored in registries |
| **Admission Control** | Blocking deployment of images that fail security checks |
| **SBOM** | Bill of materials generated from container image |
| **Ignore Unfixed** | Skipping vulnerabilities with no available patch |

---

## Quick Revision Questions

1. **Why do container images have so many vulnerabilities?**
   > Container images include the entire OS layer with hundreds of system packages. 60-80% of image vulnerabilities come from the base OS layer (openssl, libc, etc.), not from application code. Full OS images like `ubuntu:latest` contain packages you never use but still have vulnerabilities.

2. **What is the difference between scanning at build time vs registry?**
   > Build-time scanning catches vulnerabilities before pushing to the registry (gate). Registry scanning continuously re-scans stored images as new CVEs are published daily — an image that was clean yesterday may have vulnerabilities today.

3. **When should you use `--ignore-unfixed`?**
   > When a vulnerability exists in a system package but the maintainer hasn't released a patch yet. Without this flag, the scanner blocks on unfixable issues. Use it to focus on actionable vulnerabilities while tracking unfixed ones separately.

4. **What is the recommended scanning strategy for containers?**
   > Scan at four stages: (1) Build — before pushing to registry, (2) Registry — continuous re-scanning, (3) Deploy — admission controller checks, (4) Runtime — monitor for new CVEs affecting running containers.

5. **How does Trivy differ from Grype?**
   > Both are fast, free, open-source image scanners. Trivy is more feature-rich: it also scans IaC files, detects secrets, generates SBOMs, and scans file systems. Grype is focused purely on vulnerability detection and integrates tightly with Syft for SBOM generation.

---

[← Previous: 5.5 Dependency Updates](../05-SCA/05-dependency-updates.md) | [Next: 6.2 Base Image Selection →](02-base-image-selection.md)

[Back to Table of Contents](../README.md)
